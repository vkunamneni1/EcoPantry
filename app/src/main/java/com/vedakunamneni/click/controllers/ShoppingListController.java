package com.vedakunamneni.click.controllers;

import java.io.IOException;
import java.net.URL;
import java.time.LocalDate;
import java.util.List;
import java.util.ResourceBundle;

import com.vedakunamneni.click.App;
import com.vedakunamneni.click.SessionManager;
import com.vedakunamneni.db.DatabaseHelper;

import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.geometry.Insets;

public class ShoppingListController implements Initializable {

    @FXML
    private VBox shoppingListContainer;

    @Override
    public void initialize(URL location, ResourceBundle resources) {
        loadShoppingList();
    }

    private void loadShoppingList() {
        if (shoppingListContainer == null) return;
        
        String userEmail = SessionManager.getCurrentUser();
        if (userEmail == null) return;
        
        shoppingListContainer.getChildren().clear();
        
        List<ShoppingListItem> shoppingList = DatabaseHelper.getShoppingListWithIds(userEmail);
        
        if (shoppingList.isEmpty()) {
            Label emptyLabel = new Label("Your shopping list is empty");
            emptyLabel.setStyle("-fx-text-fill: #9ca3af; -fx-font-style: italic; -fx-font-size: 16px; -fx-padding: 20;");
            shoppingListContainer.getChildren().add(emptyLabel);
        } else {
            for (ShoppingListItem item : shoppingList) {
                VBox itemBox = createShoppingListItemBox(item);
                shoppingListContainer.getChildren().add(itemBox);
            }
        }
    }

    private VBox createShoppingListItemBox(ShoppingListItem item) {
        VBox itemBox = new VBox(8);
        itemBox.getStyleClass().add("shopping-list-item");
        itemBox.setStyle("-fx-background-color: #f9fafb; -fx-border-color: #e5e7eb; -fx-border-radius: 6; -fx-background-radius: 6; -fx-padding: 12;");
        
        // Create main content row
        HBox mainRow = new HBox(10);
        mainRow.setStyle("-fx-alignment: center-left;");
        
        // Item label with emoji
        String emoji = getIngredientEmoji(item.ingredientName);
        Label itemLabel = new Label(emoji + " " + item.ingredientName + " (for " + item.recipeName + ")");
        itemLabel.setStyle("-fx-font-size: 14px; -fx-text-fill: #374151; -fx-font-weight: 500;");
        
        // Spacer to push dropdown to the right
        javafx.scene.layout.Region spacer = new javafx.scene.layout.Region();
        HBox.setHgrow(spacer, javafx.scene.layout.Priority.ALWAYS);
        
        // Create action dropdown
        ComboBox<String> actionDropdown = new ComboBox<>();
        actionDropdown.getItems().addAll("Select Action", "Remove", "Add to Inventory");
        actionDropdown.setValue("Select Action");
        actionDropdown.setStyle("-fx-font-size: 12px; -fx-padding: 5 10;");
        
        // Handle dropdown selection
        actionDropdown.setOnAction(e -> {
            String selectedAction = actionDropdown.getValue();
            if ("Remove".equals(selectedAction)) {
                removeShoppingListItem(item);
            } else if ("Add to Inventory".equals(selectedAction)) {
                addToInventoryFromShoppingList(item);
            }
            // Reset dropdown
            actionDropdown.setValue("Select Action");
        });
        
        mainRow.getChildren().addAll(itemLabel, spacer, actionDropdown);
        itemBox.getChildren().add(mainRow);
        
        return itemBox;
    }

    private void removeShoppingListItem(ShoppingListItem item) {
        if (DatabaseHelper.removeFromShoppingList(item.id)) {
            loadShoppingList(); // Refresh the list
        }
    }

    private void addToInventoryFromShoppingList(ShoppingListItem item) {
        // Show dialog to get quantity and expiration date
        Dialog<Boolean> dialog = new Dialog<>();
        dialog.setTitle("Add to Inventory");
        dialog.setHeaderText("Add " + item.ingredientName + " to your inventory");
        
        // Create the form
        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(10);
        grid.setPadding(new Insets(20, 150, 10, 10));
        
        TextField quantityField = new TextField();
        quantityField.setPromptText("Quantity");
        quantityField.setText("1");
        
        DatePicker datePicker = new DatePicker();
        datePicker.setValue(LocalDate.now().plusDays(7)); // Default 7 days from now
        
        grid.add(new Label("Quantity:"), 0, 0);
        grid.add(quantityField, 1, 0);
        grid.add(new Label("Expiration Date:"), 0, 1);
        grid.add(datePicker, 1, 1);
        
        dialog.getDialogPane().setContent(grid);
        
        // Add buttons
        javafx.scene.control.ButtonType addButtonType = new javafx.scene.control.ButtonType("Add", javafx.scene.control.ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(addButtonType, javafx.scene.control.ButtonType.CANCEL);
        
        // Handle result
        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == addButtonType) {
                try {
                    int quantity = Integer.parseInt(quantityField.getText().trim());
                    LocalDate expirationDate = datePicker.getValue();
                    
                    if (quantity > 0 && expirationDate != null) {
                        String userEmail = SessionManager.getCurrentUser();
                        if (userEmail != null) {
                            // Add to inventory
                            boolean added = DatabaseHelper.addToInventory(userEmail, item.ingredientName, quantity, expirationDate);
                            if (added) {
                                // Remove from shopping list
                                DatabaseHelper.removeFromShoppingList(item.id);
                                return true;
                            }
                        }
                    }
                } catch (NumberFormatException e) {
                    // Invalid quantity
                }
            }
            return false;
        });
        
        dialog.showAndWait().ifPresent(success -> {
            if (success) {
                loadShoppingList(); // Refresh the list
                showAlert("Success", item.ingredientName + " has been added to your inventory and removed from shopping list!");
            } else {
                showAlert("Error", "Failed to add item to inventory. Please check your input.");
            }
        });
    }

    private void showAlert(String title, String message) {
        javafx.scene.control.Alert alert = new javafx.scene.control.Alert(javafx.scene.control.Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    @FXML
    private void clearAllShoppingList() {
        String userEmail = SessionManager.getCurrentUser();
        if (userEmail == null) return;
        
        // Show confirmation dialog
        javafx.scene.control.Alert confirmAlert = new javafx.scene.control.Alert(javafx.scene.control.Alert.AlertType.CONFIRMATION);
        confirmAlert.setTitle("Clear Shopping List");
        confirmAlert.setHeaderText("Remove all items from shopping list?");
        confirmAlert.setContentText("Are you sure you want to clear your entire shopping list?");
        
        confirmAlert.showAndWait().ifPresent(response -> {
            if (response == javafx.scene.control.ButtonType.OK) {
                if (DatabaseHelper.clearShoppingList(userEmail)) {
                    loadShoppingList(); // Refresh the list
                }
            }
        });
    }

    // Navigation methods
    @FXML
    private void goToDashboard() throws IOException {
        App.setRoot("dashboard");
    }

    @FXML
    private void goToInventory() throws IOException {
        App.setRoot("inventory");
    }

    @FXML
    private void goToRecipes() throws IOException {
        App.setRoot("recipe");
    }

    @FXML
    private void goToScanner() throws IOException {
        App.setRoot("scanner");
    }

    @FXML
    private void goToStatistics() throws IOException {
        App.setRoot("statistics");
    }

    @FXML
    private void handleLogout() throws IOException {
        SessionManager.logout();
        App.setRoot("start");
    }

    // Inner class to represent shopping list items with IDs
    public static class ShoppingListItem {
        public final int id;
        public final String ingredientName;
        public final String recipeName;
        
        public ShoppingListItem(int id, String ingredientName, String recipeName) {
            this.id = id;
            this.ingredientName = ingredientName;
            this.recipeName = recipeName;
        }
    }
    
    private String getIngredientEmoji(String ingredient) {
        String lowerIngredient = ingredient.toLowerCase();
        
        // Fruits
        if (lowerIngredient.contains("apple")) return "üçé";
        if (lowerIngredient.contains("banana")) return "üçå";
        if (lowerIngredient.contains("orange")) return "üçä";
        if (lowerIngredient.contains("lemon")) return "üçã";
        if (lowerIngredient.contains("lime")) return "üçã";
        if (lowerIngredient.contains("grape")) return "üçá";
        if (lowerIngredient.contains("strawberry")) return "üçì";
        if (lowerIngredient.contains("raspberry")) return "ü´ê";
        if (lowerIngredient.contains("blueberry")) return "ü´ê";
        if (lowerIngredient.contains("blackberry")) return "ü´ê";
        if (lowerIngredient.contains("cherry")) return "üçí";
        if (lowerIngredient.contains("peach")) return "üçë";
        if (lowerIngredient.contains("pear")) return "üçê";
        if (lowerIngredient.contains("pineapple")) return "üçç";
        if (lowerIngredient.contains("mango")) return "ü•≠";
        if (lowerIngredient.contains("avocado")) return "ü•ë";
        if (lowerIngredient.contains("coconut")) return "ü••";
        if (lowerIngredient.contains("kiwi")) return "ü•ù";
        if (lowerIngredient.contains("watermelon")) return "üçâ";
        if (lowerIngredient.contains("melon")) return "üçà";
        if (lowerIngredient.contains("cantaloupe")) return "üçà";
        if (lowerIngredient.contains("papaya")) return "ü•≠";
        if (lowerIngredient.contains("plum")) return "üü£";
        if (lowerIngredient.contains("apricot")) return "üçë";
        
        // Vegetables
        if (lowerIngredient.contains("tomato")) return "üçÖ";
        if (lowerIngredient.contains("carrot")) return "ü•ï";
        if (lowerIngredient.contains("broccoli")) return "ü•¶";
        if (lowerIngredient.contains("spinach")) return "ü•¨";
        if (lowerIngredient.contains("lettuce")) return "ü•¨";
        if (lowerIngredient.contains("cabbage")) return "ü•¨";
        if (lowerIngredient.contains("kale")) return "ü•¨";
        if (lowerIngredient.contains("arugula")) return "ü•¨";
        if (lowerIngredient.contains("onion")) return "üßÖ";
        if (lowerIngredient.contains("garlic")) return "üßÑ";
        if (lowerIngredient.contains("ginger")) return "ü´ö";
        if (lowerIngredient.contains("potato")) return "ü•î";
        if (lowerIngredient.contains("sweet potato")) return "üç†";
        if (lowerIngredient.contains("mushroom")) return "üçÑ";
        if (lowerIngredient.contains("bell pepper")) return "ü´ë";
        if (lowerIngredient.contains("pepper") && !lowerIngredient.contains("bell")) return "üå∂Ô∏è";
        if (lowerIngredient.contains("chili")) return "üå∂Ô∏è";
        if (lowerIngredient.contains("jalapeno")) return "üå∂Ô∏è";
        if (lowerIngredient.contains("cucumber")) return "ü•í";
        if (lowerIngredient.contains("zucchini")) return "ü•í";
        if (lowerIngredient.contains("eggplant")) return "üçÜ";
        if (lowerIngredient.contains("corn")) return "üåΩ";
        if (lowerIngredient.contains("peas")) return "üü¢";
        if (lowerIngredient.contains("green bean")) return "ü•¶";
        if (lowerIngredient.contains("asparagus")) return "ü•¶";
        if (lowerIngredient.contains("celery")) return "ü•¨";
        if (lowerIngredient.contains("radish")) return "üü£";
        if (lowerIngredient.contains("beet")) return "üî¥";
        if (lowerIngredient.contains("turnip")) return "‚ö™";
        if (lowerIngredient.contains("parsnip")) return "‚ö™";
        if (lowerIngredient.contains("leek")) return "üßÖ";
        if (lowerIngredient.contains("shallot")) return "üßÖ";
        if (lowerIngredient.contains("scallion")) return "üåø";
        if (lowerIngredient.contains("green onion")) return "üåø";
        if (lowerIngredient.contains("chive")) return "üåø";
        
        // Grains & Cereals
        if (lowerIngredient.contains("rice")) return "üçö";
        if (lowerIngredient.contains("bread")) return "üçû";
        if (lowerIngredient.contains("pasta")) return "üçù";
        if (lowerIngredient.contains("noodle")) return "üçú";
        if (lowerIngredient.contains("oat")) return "ü•£";
        if (lowerIngredient.contains("quinoa")) return "üåæ";
        if (lowerIngredient.contains("barley")) return "üåæ";
        if (lowerIngredient.contains("wheat")) return "üåæ";
        if (lowerIngredient.contains("flour")) return "üåæ";
        if (lowerIngredient.contains("cereal")) return "ü•£";
        if (lowerIngredient.contains("bagel")) return "ü•Ø";
        if (lowerIngredient.contains("croissant")) return "ü•ê";
        if (lowerIngredient.contains("pretzel")) return "ü•®";
        
        // Proteins
        if (lowerIngredient.contains("chicken")) return "üçó";
        if (lowerIngredient.contains("beef")) return "ü•©";
        if (lowerIngredient.contains("pork")) return "ü•©";
        if (lowerIngredient.contains("lamb")) return "ü•©";
        if (lowerIngredient.contains("turkey")) return "ü¶É";
        if (lowerIngredient.contains("duck")) return "ü¶Ü";
        if (lowerIngredient.contains("fish")) return "üêü";
        if (lowerIngredient.contains("salmon")) return "üêü";
        if (lowerIngredient.contains("tuna")) return "üêü";
        if (lowerIngredient.contains("shrimp")) return "ü¶ê";
        if (lowerIngredient.contains("crab")) return "ü¶Ä";
        if (lowerIngredient.contains("lobster")) return "ü¶û";
        if (lowerIngredient.contains("scallop")) return "üêö";
        if (lowerIngredient.contains("oyster")) return "ü¶™";
        if (lowerIngredient.contains("mussel")) return "üêö";
        if (lowerIngredient.contains("clam")) return "üêö";
        if (lowerIngredient.contains("squid")) return "ü¶ë";
        if (lowerIngredient.contains("octopus")) return "üêô";
        if (lowerIngredient.contains("egg")) return "ü•ö";
        if (lowerIngredient.contains("tofu")) return "‚¨ú";
        if (lowerIngredient.contains("tempeh")) return "üü§";
        
        // Dairy
        if (lowerIngredient.contains("milk")) return "ü•õ";
        if (lowerIngredient.contains("cheese")) return "üßÄ";
        if (lowerIngredient.contains("yogurt")) return "ü•õ";
        if (lowerIngredient.contains("butter")) return "üßà";
        if (lowerIngredient.contains("cream")) return "ü•õ";
        if (lowerIngredient.contains("sour cream")) return "ü•õ";
        if (lowerIngredient.contains("cottage cheese")) return "üßÄ";
        if (lowerIngredient.contains("ricotta")) return "üßÄ";
        if (lowerIngredient.contains("mozzarella")) return "üßÄ";
        if (lowerIngredient.contains("cheddar")) return "üßÄ";
        if (lowerIngredient.contains("parmesan")) return "üßÄ";
        if (lowerIngredient.contains("feta")) return "üßÄ";
        if (lowerIngredient.contains("goat cheese")) return "üßÄ";
        if (lowerIngredient.contains("brie")) return "üßÄ";
        if (lowerIngredient.contains("camembert")) return "üßÄ";
        
        // Legumes & Nuts
        if (lowerIngredient.contains("bean")) return "ü•´";
        if (lowerIngredient.contains("lentil")) return "üü§";
        if (lowerIngredient.contains("chickpea")) return "üü°";
        if (lowerIngredient.contains("garbanzo")) return "üü°";
        if (lowerIngredient.contains("black bean")) return "‚ö´";
        if (lowerIngredient.contains("kidney bean")) return "üî¥";
        if (lowerIngredient.contains("pinto bean")) return "üü§";
        if (lowerIngredient.contains("navy bean")) return "‚ö™";
        if (lowerIngredient.contains("lima bean")) return "üü¢";
        if (lowerIngredient.contains("soybean")) return "üü°";
        if (lowerIngredient.contains("almond")) return "üå∞";
        if (lowerIngredient.contains("walnut")) return "üå∞";
        if (lowerIngredient.contains("pecan")) return "üå∞";
        if (lowerIngredient.contains("cashew")) return "üå∞";
        if (lowerIngredient.contains("pistachio")) return "üå∞";
        if (lowerIngredient.contains("hazelnut")) return "üå∞";
        if (lowerIngredient.contains("macadamia")) return "üå∞";
        if (lowerIngredient.contains("brazil nut")) return "üå∞";
        if (lowerIngredient.contains("pine nut")) return "üå∞";
        if (lowerIngredient.contains("peanut")) return "ü•ú";
        if (lowerIngredient.contains("sunflower seed")) return "üåª";
        if (lowerIngredient.contains("pumpkin seed")) return "üéÉ";
        if (lowerIngredient.contains("sesame seed")) return "‚ö™";
        if (lowerIngredient.contains("chia seed")) return "‚ö´";
        if (lowerIngredient.contains("flax seed")) return "üü§";
        
        // Herbs & Spices
        if (lowerIngredient.contains("basil")) return "üåø";
        if (lowerIngredient.contains("oregano")) return "üåø";
        if (lowerIngredient.contains("thyme")) return "üåø";
        if (lowerIngredient.contains("rosemary")) return "üåø";
        if (lowerIngredient.contains("sage")) return "üåø";
        if (lowerIngredient.contains("mint")) return "üåø";
        if (lowerIngredient.contains("cilantro")) return "üåø";
        if (lowerIngredient.contains("parsley")) return "üåø";
        if (lowerIngredient.contains("dill")) return "üåø";
        if (lowerIngredient.contains("tarragon")) return "üåø";
        if (lowerIngredient.contains("bay leaf")) return "üçÉ";
        if (lowerIngredient.contains("cinnamon")) return "üü§";
        if (lowerIngredient.contains("nutmeg")) return "üü§";
        if (lowerIngredient.contains("clove")) return "üü§";
        if (lowerIngredient.contains("cardamom")) return "üü¢";
        if (lowerIngredient.contains("cumin")) return "üü§";
        if (lowerIngredient.contains("coriander")) return "üü§";
        if (lowerIngredient.contains("paprika")) return "üî¥";
        if (lowerIngredient.contains("turmeric")) return "üü°";
        if (lowerIngredient.contains("saffron")) return "üü°";
        if (lowerIngredient.contains("vanilla")) return "üü§";
        if (lowerIngredient.contains("black pepper")) return "‚ö´";
        if (lowerIngredient.contains("white pepper")) return "‚ö™";
        if (lowerIngredient.contains("cayenne")) return "üî¥";
        if (lowerIngredient.contains("mustard seed")) return "üü°";
        if (lowerIngredient.contains("fennel seed")) return "üü¢";
        if (lowerIngredient.contains("star anise")) return "‚≠ê";
        
        // Oils & Condiments
        if (lowerIngredient.contains("olive oil")) return "ü´í";
        if (lowerIngredient.contains("coconut oil")) return "ü••";
        if (lowerIngredient.contains("vegetable oil")) return "üü°";
        if (lowerIngredient.contains("canola oil")) return "üü°";
        if (lowerIngredient.contains("sesame oil")) return "üü§";
        if (lowerIngredient.contains("vinegar")) return "üç∂";
        if (lowerIngredient.contains("balsamic")) return "üü§";
        if (lowerIngredient.contains("soy sauce")) return "üü§";
        if (lowerIngredient.contains("worcestershire")) return "üü§";
        if (lowerIngredient.contains("hot sauce")) return "üå∂Ô∏è";
        if (lowerIngredient.contains("ketchup")) return "üçÖ";
        if (lowerIngredient.contains("mustard")) return "üü°";
        if (lowerIngredient.contains("mayonnaise")) return "‚ö™";
        if (lowerIngredient.contains("honey")) return "üçØ";
        if (lowerIngredient.contains("maple syrup")) return "üçÅ";
        if (lowerIngredient.contains("molasses")) return "üü§";
        if (lowerIngredient.contains("jam")) return "üçì";
        if (lowerIngredient.contains("jelly")) return "üçá";
        if (lowerIngredient.contains("peanut butter")) return "ü•ú";
        if (lowerIngredient.contains("almond butter")) return "üå∞";
        if (lowerIngredient.contains("nutella")) return "üü§";
        
        // Beverages
        if (lowerIngredient.contains("coffee")) return "‚òï";
        if (lowerIngredient.contains("tea")) return "üçµ";
        if (lowerIngredient.contains("juice")) return "üßÉ";
        if (lowerIngredient.contains("wine")) return "üç∑";
        if (lowerIngredient.contains("beer")) return "üç∫";
        if (lowerIngredient.contains("vodka")) return "üç∏";
        if (lowerIngredient.contains("rum")) return "ü•É";
        if (lowerIngredient.contains("whiskey")) return "ü•É";
        if (lowerIngredient.contains("brandy")) return "ü•É";
        if (lowerIngredient.contains("coconut water")) return "ü••";
        if (lowerIngredient.contains("soda")) return "ü•§";
        if (lowerIngredient.contains("sparkling water")) return "ü´ß";
        
        // Sweets & Desserts
        if (lowerIngredient.contains("chocolate")) return "üç´";
        if (lowerIngredient.contains("cocoa")) return "üç´";
        if (lowerIngredient.contains("sugar")) return "üßÇ";
        if (lowerIngredient.contains("brown sugar")) return "üü§";
        if (lowerIngredient.contains("powdered sugar")) return "‚ö™";
        if (lowerIngredient.contains("vanilla extract")) return "üü§";
        if (lowerIngredient.contains("baking powder")) return "‚ö™";
        if (lowerIngredient.contains("baking soda")) return "‚ö™";
        if (lowerIngredient.contains("yeast")) return "üü°";
        if (lowerIngredient.contains("cornstarch")) return "‚ö™";
        if (lowerIngredient.contains("gelatin")) return "‚ö™";
        if (lowerIngredient.contains("marshmallow")) return "‚ö™";
        if (lowerIngredient.contains("coconut flake")) return "‚ö™";
        if (lowerIngredient.contains("raisin")) return "üü§";
        if (lowerIngredient.contains("date")) return "üü§";
        if (lowerIngredient.contains("fig")) return "üü£";
        if (lowerIngredient.contains("cranberry")) return "üî¥";
        
        // Frozen Foods
        if (lowerIngredient.contains("ice cream")) return "üç®";
        if (lowerIngredient.contains("frozen yogurt")) return "üç¶";
        if (lowerIngredient.contains("sorbet")) return "üçß";
        if (lowerIngredient.contains("popsicle")) return "üç≠";
        
        // Canned/Processed
        if (lowerIngredient.contains("tomato sauce")) return "üçÖ";
        if (lowerIngredient.contains("tomato paste")) return "üçÖ";
        if (lowerIngredient.contains("coconut milk")) return "ü••";
        if (lowerIngredient.contains("almond milk")) return "üå∞";
        if (lowerIngredient.contains("oat milk")) return "ü•£";
        if (lowerIngredient.contains("soy milk")) return "üü°";
        if (lowerIngredient.contains("broth")) return "üç≤";
        if (lowerIngredient.contains("stock")) return "üç≤";
        
        return "ü•ó"; // Default emoji for other ingredients
    }
}
